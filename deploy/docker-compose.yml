services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    image: mosaic-terminal:local
    container_name: mosaic-terminal
    restart: unless-stopped
    env_file:
      - .env
    environment:
      MOSAIC_SSH_HOST: ${MOSAIC_SSH_HOST:-0.0.0.0}
      MOSAIC_SSH_PORT: ${MOSAIC_SSH_PORT:-2222}
      MOSAIC_SSH_HOST_KEY_PATH: ${MOSAIC_SSH_HOST_KEY_PATH:-/run/keys/ssh_host_ed25519}
      MOSAIC_ARCHIVE_ROOT: ${MOSAIC_ARCHIVE_ROOT:-/archive}
    ports:
      - "${MOSAIC_SSH_PUBLISH_PORT:-22}:2222"
      - "${MOSAIC_GATEWAY_PUBLISH_PORT:-8080}:8080"
    volumes:
      - type: bind
        source: ./data/ssh/host_ed25519
        target: /run/keys/ssh_host_ed25519
        read_only: true
      - type: bind
        source: ${MOSAIC_ARCHIVE_HOST_DIR:-./data/archive}
        target: ${MOSAIC_ARCHIVE_ROOT:-/archive}
    healthcheck:
      test:
        - CMD-SHELL
        - nc -z 127.0.0.1 2222 || exit 1
      interval: 20s
      timeout: 5s
      retries: 5
      start_period: 20s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - mosaic-app

  web:
    build:
      context: ../web
      dockerfile: Dockerfile
    image: mosaic-web:local
    restart: unless-stopped
    depends_on:
      app:
        condition: service_healthy
    environment:
      WEB_PORT: 3000
      SSH_HOST: app
      SSH_PORT: 2222
      GATEWAY_BASE_URL: http://app:8080
      GATEWAY_TARGET_HOST: app
      GATEWAY_TARGET_PORT: 2222
    ports:
      - "${MOSAIC_WEB_PUBLISH_PORT:-3000}:3000"
    healthcheck:
      test:
        - CMD
        - node
        - -e
        - "fetch('http://127.0.0.1:3000').then((response)=>process.exit(response.ok ? 0 : 1)).catch(()=>process.exit(1))"
      interval: 20s
      timeout: 5s
      retries: 5
      start_period: 20s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - mosaic-app

  neo4j:
    image: neo4j:5.24.2-community
    container_name: mosaic-neo4j
    profiles:
      - neo4j
    restart: unless-stopped
    environment:
      NEO4J_AUTH: ${NEO4J_AUTH:-neo4j/localdevpassword}
    ports:
      - "7474:7474"
      - "7687:7687"
    volumes:
      - neo4j-data:/data
      - neo4j-logs:/logs
    healthcheck:
      test:
        - CMD-SHELL
        - >-
          PASS="$${NEO4J_AUTH#neo4j/}";
          cypher-shell -u neo4j -p "$$PASS" 'RETURN 1;' >/dev/null 2>&1
      interval: 20s
      timeout: 10s
      retries: 5
      start_period: 30s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - mosaic-app

networks:
  mosaic-app:
    name: mosaic-app

volumes:
  neo4j-data:
  neo4j-logs:
