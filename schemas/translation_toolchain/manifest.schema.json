{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://readmosaic/schemas/translation_toolchain/manifest.schema.json",
  "title": "translation toolchain manifest.json",
  "type": "object",
  "required": [
    "run_id",
    "pipeline_profile",
    "source",
    "model",
    "pass1_language",
    "pass2_language",
    "semantic_language",
    "script_mode",
    "source_pre",
    "pass1_pre",
    "pass2_pre",
    "review_pre_dir",
    "final",
    "gate",
    "aggregation_policy_snapshot",
    "canonical_state_counts",
    "created_at",
    "updated_at"
  ],
  "properties": {
    "run_id": {
      "type": "string",
      "minLength": 1
    },
    "pipeline_profile": {
      "type": "string",
      "minLength": 1
    },
    "source": {
      "type": "string",
      "minLength": 1
    },
    "model": {
      "type": "string",
      "minLength": 1
    },
    "pass1_language": {
      "type": "string",
      "minLength": 1
    },
    "pass2_language": {
      "type": [
        "string",
        "null"
      ]
    },
    "semantic_language": {
      "type": "string",
      "minLength": 1
    },
    "script_mode": {
      "type": "string",
      "enum": [
        "single_pass",
        "two_pass"
      ]
    },
    "source_pre": {
      "type": "string",
      "pattern": "^runs/.+/source_pre$"
    },
    "pass1_pre": {
      "type": "string",
      "pattern": "^runs/.+/pass1_pre$"
    },
    "pass2_pre": {
      "type": "string",
      "pattern": "^runs/.+/pass2_pre$"
    },
    "review_pre_dir": {
      "type": "string",
      "enum": [
        "pass1_pre",
        "pass2_pre"
      ]
    },
    "final": {
      "type": "string",
      "pattern": "^runs/.+/final/final\\.md$"
    },
    "gate": {
      "type": "string",
      "pattern": "^runs/.+/gate/gate_report\\.json$"
    },
    "aggregation_policy_snapshot": {
      "type": "object",
      "required": [
        "max_paragraph_attempts",
        "score_thresholds",
        "immediate_manual_review_reasons"
      ],
      "properties": {
        "max_paragraph_attempts": {
          "type": "integer",
          "minimum": 1
        },
        "score_thresholds": {
          "type": "object",
          "additionalProperties": {
            "type": "number"
          }
        },
        "immediate_manual_review_reasons": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1
          },
          "uniqueItems": true
        }
      },
      "additionalProperties": false
    },
    "canonical_state_counts": {
      "type": "object",
      "required": [
        "total",
        "required_total",
        "required_merge_blockers",
        "done",
        "in_flight",
        "progress_percent",
        "status_counts"
      ],
      "properties": {
        "total": {
          "type": "integer",
          "minimum": 0
        },
        "required_total": {
          "type": "integer",
          "minimum": 0
        },
        "required_merge_blockers": {
          "type": "integer",
          "minimum": 0
        },
        "done": {
          "type": "integer",
          "minimum": 0
        },
        "in_flight": {
          "type": "integer",
          "minimum": 0
        },
        "progress_percent": {
          "type": "number",
          "minimum": 0
        },
        "status_counts": {
          "type": "object",
          "additionalProperties": {
            "type": "integer",
            "minimum": 0
          }
        }
      },
      "additionalProperties": false
    },
    "status_checkpoint": {
      "type": "object",
      "required": [
        "phase",
        "phase_state",
        "updated_at"
      ],
      "properties": {
        "phase": {
          "type": "string",
          "minLength": 1
        },
        "phase_state": {
          "type": "string",
          "enum": [
            "running",
            "done",
            "error"
          ]
        },
        "updated_at": {
          "type": "string",
          "format": "date-time"
        }
      },
      "additionalProperties": false
    },
    "created_at": {
      "type": "string",
      "format": "date-time"
    },
    "updated_at": {
      "type": "string",
      "format": "date-time"
    },
    "source_content_hash": {
      "$ref": "defs.schema.json#/$defs/content_hash"
    },
    "exclusion_policy": {
      "type": "object",
      "properties": {
        "metadata": {
          "type": "object",
          "additionalProperties": {
            "type": [
              "string",
              "number",
              "boolean",
              "null"
            ]
          }
        },
        "rules": {
          "type": "array",
          "items": {
            "type": "object",
            "required": [
              "paragraph_id",
              "reason"
            ],
            "properties": {
              "paragraph_id": {
                "$ref": "defs.schema.json#/$defs/paragraph_id"
              },
              "reason": {
                "type": "string",
                "minLength": 1
              }
            },
            "additionalProperties": false
          }
        },
        "templates": {
          "type": "array",
          "items": {
            "type": "object",
            "required": [
              "pattern",
              "reason"
            ],
            "properties": {
              "pattern": {
                "type": "string",
                "minLength": 1
              },
              "reason": {
                "type": "string",
                "minLength": 1
              },
              "ignore_case": {
                "type": "boolean"
              }
            },
            "additionalProperties": false
          }
        }
      },
      "additionalProperties": false
    },
    "orchestration_status": {
      "type": "object",
      "required": [
        "mode",
        "rework_cycles_completed",
        "stop_reason",
        "queue_remaining",
        "manual_review_remaining",
        "max_rework_cycles",
        "phase_f_policy",
        "updated_at"
      ],
      "properties": {
        "mode": {
          "type": "string",
          "enum": [
            "converge"
          ]
        },
        "rework_cycles_completed": {
          "type": "integer",
          "minimum": 0
        },
        "stop_reason": {
          "type": "string",
          "enum": [
            "running",
            "converged_no_blockers",
            "manual_review_only",
            "max_rework_cycles_reached"
          ]
        },
        "queue_remaining": {
          "type": "integer",
          "minimum": 0
        },
        "manual_review_remaining": {
          "type": "integer",
          "minimum": 0
        },
        "max_rework_cycles": {
          "type": "integer",
          "minimum": 1
        },
        "phase_f_policy": {
          "type": "string",
          "enum": [
            "each_cycle",
            "final_only"
          ]
        },
        "updated_at": {
          "type": "string",
          "format": "date-time"
        }
      },
      "additionalProperties": false
    }
  },
  "additionalProperties": false
}
