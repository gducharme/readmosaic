# AUTO-GENERATED by seedpipe.tools.compile
# DO NOT EDIT. Changes will be overwritten.
# Source: pipeline.yaml hash: sha256:94ffa461f978c5eb616be7b6f51bfbead2d33a3f1169ce47e44c9cdbc415d1e2
# Contracts hash: sha256:da7fb7e4e9d3ad66fdc6a9db71bdc78268e8206ab9df353348b332de77570731

from __future__ import annotations

import argparse
from datetime import datetime, timezone
from pathlib import Path

from seedpipe.generated.stages import preprocessing as stage_preprocessing
from seedpipe.generated.stages import word_frequency_benchmark as stage_word_frequency_benchmark
from seedpipe.generated.stages import style_slop_detectors as stage_style_slop_detectors
from seedpipe.generated.stages import transform as stage_transform
from seedpipe.generated.stages import reviewer_pass as stage_reviewer_pass
from seedpipe.generated.stages import publish as stage_publish

from seedpipe.runtime.ctx import StageContext
from seedpipe.runtime.items import iter_items_deterministic
from seedpipe.runtime.state import append_item_state_row

PIPELINE_ID = 'slop-stop-pipeline'
ITEM_UNIT = 'paragraph'
DETERMINISM_POLICY = 'strict'
STAGES = ['preprocessing', 'word_frequency_benchmark', 'style_slop_detectors', 'transform', 'reviewer_pass', 'publish']

def now_rfc3339() -> str:
    return datetime.now(timezone.utc).isoformat()

def run(run_config: dict[str, object], attempt: int = 1) -> int:
    run_id = str(run_config['run_id'])
    run_config.setdefault('_pipe_root', str(Path(__file__).resolve().parents[1]))
    ctx_base = StageContext.make_base(run_config=run_config)
    ctx = ctx_base.for_stage('preprocessing', attempt=attempt, keys={}, expected_outputs=[{'family': 'preprocessed', 'pattern': 'preprocessed/preprocessed.json', 'schema': 'preprocessed.schema.json', 'path': 'preprocessed/preprocessed.json', 'keys': {}}, {'family': 'paragraphs', 'pattern': 'preprocessed/paragraphs.jsonl', 'schema': 'paragraphs.schema.json', 'path': 'preprocessed/paragraphs.jsonl', 'keys': {}}])
    stage_preprocessing.run_whole(ctx)
    ctx = ctx_base.for_stage('word_frequency_benchmark', attempt=attempt, keys={}, expected_outputs=[{'family': 'lexical_frequency', 'pattern': 'lexical/word_frequency_report.json', 'schema': 'word_frequency_report.schema.json', 'path': 'lexical/word_frequency_report.json', 'keys': {}}])
    stage_word_frequency_benchmark.run_whole(ctx)
    ctx = ctx_base.for_stage('style_slop_detectors', attempt=attempt, keys={}, expected_outputs=[{'family': 'style_slop_findings', 'pattern': 'diagnostics/style_slop_findings.json', 'schema': 'style_slop_findings.schema.json', 'path': 'diagnostics/style_slop_findings.json', 'keys': {}}, {'family': 'rewrite_candidates', 'pattern': 'diagnostics/rewrite_candidates.jsonl', 'schema': 'rewrite_candidates.schema.json', 'path': 'diagnostics/rewrite_candidates.jsonl', 'keys': {}}])
    stage_style_slop_detectors.run_whole(ctx)
    ctx = ctx_base.for_stage('transform', attempt=attempt, keys={}, expected_outputs=[{'family': 'transformed_rewrites', 'pattern': 'transforms/transformed.jsonl', 'schema': 'transformed_rewrites.schema.json', 'path': 'transforms/transformed.jsonl', 'keys': {}}])
    stage_transform.run_whole(ctx)
    ctx = ctx_base.for_stage('reviewer_pass', attempt=attempt, keys={}, expected_outputs=[{'family': 'reviewed_rewrites', 'pattern': 'review/reviewed.jsonl', 'schema': 'reviewed_rewrites.schema.json', 'path': 'review/reviewed.jsonl', 'keys': {}}, {'family': 'review_summary', 'pattern': 'review/review_summary.json', 'schema': 'review_summary.schema.json', 'path': 'review/review_summary.json', 'keys': {}}])
    stage_reviewer_pass.run_whole(ctx)
    ctx = ctx_base.for_stage('publish', attempt=attempt, keys={}, expected_outputs=[{'family': 'manifest', 'pattern': 'manifest.json', 'schema': 'manifest.schema.json', 'path': 'manifest.json', 'keys': {}}])
    stage_publish.run_whole(ctx)
    return 0

def main() -> None:
    parser = argparse.ArgumentParser(description='Run generated Seedpipe flow')
    parser.add_argument('--run-id', required=True)
    parser.add_argument('--attempt', type=int, default=1)
    args = parser.parse_args()
    code = run(run_config={'run_id': args.run_id}, attempt=args.attempt)
    raise SystemExit(code)

if __name__ == '__main__':
    main()
