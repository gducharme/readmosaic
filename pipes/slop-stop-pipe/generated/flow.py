# AUTO-GENERATED by seedpipe.tools.compile
# DO NOT EDIT. Changes will be overwritten.
# Source: pipeline.yaml hash: sha256:3ab64fe27278937d9cd9a7060142977cca79d1fb179e5fba7f29fa4971345b72
# Contracts hash: sha256:da7fb7e4e9d3ad66fdc6a9db71bdc78268e8206ab9df353348b332de77570731

from __future__ import annotations

import argparse
from datetime import datetime, timezone

from seedpipe.generated.stages import preprocessing as stage_preprocessing
from seedpipe.generated.stages import word_frequency_benchmark as stage_word_frequency_benchmark
from seedpipe.generated.stages import ingest as stage_ingest
from seedpipe.generated.stages import transform as stage_transform
from seedpipe.generated.stages import future_review as stage_future_review
from seedpipe.generated.stages import publish as stage_publish

from seedpipe.runtime.ctx import StageContext
from seedpipe.runtime.items import iter_items_deterministic
from seedpipe.runtime.state import append_item_state_row

PIPELINE_ID = 'example-pipeline'
ITEM_UNIT = 'item'
DETERMINISM_POLICY = 'strict'
STAGES = ['preprocessing', 'word_frequency_benchmark', 'ingest', 'transform', 'future_review', 'publish']

def now_rfc3339() -> str:
    return datetime.now(timezone.utc).isoformat()

def run(run_config: dict[str, object], attempt: int = 1) -> int:
    run_id = str(run_config['run_id'])
    ctx_base = StageContext.make_base(run_config=run_config)
    ctx = ctx_base.for_stage('preprocessing', attempt=attempt)
    stage_preprocessing.run_whole(ctx)
    ctx = ctx_base.for_stage('word_frequency_benchmark', attempt=attempt)
    stage_word_frequency_benchmark.run_whole(ctx)
    ctx = ctx_base.for_stage('ingest', attempt=attempt)
    stage_ingest.run_whole(ctx)
    ctx = ctx_base.for_stage('transform', attempt=attempt)
    for item in iter_items_deterministic(ctx, items_artifact='items.jsonl'):
        item_id = item['item_id']
        append_item_state_row({
            'run_id': run_id,
            'item_id': item_id,
            'state': 'in_progress',
            'stage_id': 'transform',
            'attempt': attempt,
            'updated_at': now_rfc3339(),
        })
        res = stage_transform.run_item(ctx, item)
        if res.ok:
            append_item_state_row({
                'run_id': run_id,
                'item_id': item_id,
                'state': 'succeeded',
                'stage_id': 'transform',
                'attempt': attempt,
                'updated_at': now_rfc3339(),
            })
        else:
            append_item_state_row({
                'run_id': run_id,
                'item_id': item_id,
                'state': 'failed',
                'stage_id': 'transform',
                'attempt': attempt,
                'error': res.error,
                'updated_at': now_rfc3339(),
            })
    ctx = ctx_base.for_stage('future_review', attempt=attempt)
    stage_future_review.run_whole(ctx)
    ctx = ctx_base.for_stage('publish', attempt=attempt)
    stage_publish.run_whole(ctx)
    return 0

def main() -> None:
    parser = argparse.ArgumentParser(description='Run generated Seedpipe flow')
    parser.add_argument('--run-id', required=True)
    parser.add_argument('--attempt', type=int, default=1)
    args = parser.parse_args()
    code = run(run_config={'run_id': args.run_id}, attempt=args.attempt)
    raise SystemExit(code)

if __name__ == '__main__':
    main()
